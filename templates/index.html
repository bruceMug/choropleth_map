<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Blue map d3</title>
    <link rel="stylesheet" href="../static/style.css">
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM"
      crossorigin="anonymous"
    />
  </head>

  <body>
    <div class="border border-dark">
      <svg width="700" height="600"></svg>
    </div>

    <div
      id="tooltip"
      style="position: absolute; visibility: hidden"
      class="text-dark bg-info rounded p-1"
    ></div>

    <script src="https://d3js.org/d3.v4.js"></script>
    <script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>
    <script>
      const width = innerWidth;
      const height = innerHeight;

      var svg = d3.select("svg").attr("width", width).attr("height", height);
      var tooltip = d3.select("#tooltip");

      const chuckSize = 50;

      //initialize zoom behavior
      const zoom = d3.zoom().scaleExtent([1, 8]).on("zoom", zoomed);
      //apply zoom behavior to svg
      svg.call(zoom);

      function zoomed() {
        svg.selectAll('path').attr("transform", d3.event.transform).attr('stroke-width', 0.5);
        svg.selectAll('text').attr("transform", d3.event.transform);
      }

      //=======================================================load features======================
      function loadFeatures(features, startIdx) {
        var gfg = d3
          .geoMercator()
          .scale(width / 0.1 / Math.PI) //==uganda===
          //.scale(width / 1.2 / Math.PI)
          .rotate([90, 0])
          //.center([110, 0])
          //.center([120, 0])
          .center([122, 1])
          .translate([width / 2, height / 2]);

        const path = d3.geoPath().projection(gfg);

        var colorScale = d3
          .scaleThreshold()
          .domain([0, 12, 35.5, 55.5, 150.5, 250.4])
          .range(["green", "yellow", "orange", "red", "purple", "maroon"]);

        svg
          .append("g")
          .selectAll("path")
          .data(features)
          .enter()
          .append("path")
          .attr("d", path)
          //.attr("fill", "Turquoise")
          .attr("fill", function (d) {
            var pm = d.properties.pm2_5;
            return colorScale(pm);
          })
          .attr("stroke", "#ffff")
          .attr("stroke-width", 1)

          .on("mouseover", function (d) {
            d3.select(this).attr("fill", "black");

            //tooltip
            tooltip
              .style("visibility", "visible")
              .html(
                d.properties.parish + "<br>" + "pm2_5: " + d.properties.pm2_5
              )
              .style("left", d3.event.pageX + 20 + "px")
              .style("top", d3.event.pageY - 10 + "px");
          })
          .on("mouseout", function (d) {
            d3.select(this)
              //.attr("fill", "Turquoise")
              .attr("fill", function (d) {
                var pm = d.properties.pm2_5;
                return colorScale(pm);
              })
              .style("stroke", "#ffff")
              .style("stroke-width", 1);

            tooltip.style("visibility", "hidden");
          });
        
        
        svg
          .append("g")
          .selectAll("text")
          .data(features)
          .enter()
          .filter(function (d) {
            return d.properties.parish.length < 10;
          })
          .append("text")
          .attr("x", function (d) {
              return path.centroid(d)[0];
          })
          .attr("y", function (d) {
              return path.centroid(d)[1];
          })
          .text(function (d) {
              return d.properties.parish;
          })
          .attr("text-anchor", "middle")
          .attr("alignment-baseline", "middle")
          .attr("fill", "black")
          .style("font-size", "10px");
        
          console.log("mapping is done!");
      }
      //==========================================================================================

      

      //=======================================================fetch and render map===============
      function fetchAndRenderMap(offset) {
        d3.json(`/map?offset=${offset}`, function (data) {
          console.log("Inside.. and plotting next");
          //console.log(data.features);

          loadFeatures(data.features, 0);

          if (data.features.length > 0) {
            const nextOffset = offset + data.features.length;
            console.log("nextOffset is ", nextOffset);
            fetchAndRenderMap(nextOffset);
          }
        });
      }
      //===========================================================================================
      console.log("am here ==> ");
      fetchAndRenderMap(0);



      //=======================================================
      /*
      d3.json("/map2", function(data){
        console.log("Map2 route data available...");
        loadFeatures(data.features, 0);
      });
      */
      //=======================================================
    </script>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
